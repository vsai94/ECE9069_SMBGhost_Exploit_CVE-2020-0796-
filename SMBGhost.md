# SMBGhost Vulnerability CVE-2022-0796

## How does the SMB protocol work?

The SMB protocol enables applications and their users to access files on remote servers, as well as connect to other resources, including printers, mailslots and named pipes. SMB provides client applications with a secure and controlled method for opening, reading, moving, creating and updating files on remote servers. The protocol can also communicate with server programs configured to receive SMB client requests.

Known as a response-request protocol, the SMB protocol is one of the most common methods used for network communications. In this model, the client sends an SMB request to the server to initiate the connection. When the server receives the request, it replies by sending an SMB response back to the client, establishing the communication channel necessary for a two-way conversation.

The SMB protocol operates at the application layer but relies on lower network levels for transport. At one time, SMB ran on top of Network Basic Input/Output System over Transmission Control Protocol/Internet Protocol (NetBIOS over TCP/IP, or NBT) or, to a lesser degree, legacy protocols such as Internetwork Packet Exchange or NetBIOS Extended User Interface. When SMB was using NBT, it relied on ports 137, 138 and 139 for transport. Now, SMB runs directly over TCP/IP and uses port 445.

## What are SMB protocol dialects?

Since the SMB protocol was introduced, a number of SMB dialects have been released that have improved on the original implementation, delivering greater capabilities, scalability, security and efficiency. Here is a brief overview of the most notable dialects:

    - SMB 1.0 (1984). SMB 1.0 was created by IBM for file sharing in DOS. It introduced opportunistic locking (OpLock) as a client-side caching mechanism designed to reduce network traffic. Microsoft would later include the SMB protocol in its LAN Manager product.
    CIFS (1996). CIFS is a Microsoft-developed SMB dialect that debuted in Windows 95. Short for Common Internet File System, CIFS added support for larger file sizes, direct transport over TCP/IP, and symbolic links and hard links.
    
    - SMB 2.0 (2006). SMB 2.0 was released with Windows Vista and Windows Server 2008. It reduced chattiness to improve performance, enhanced scalability and resiliency, and added support for wide area network (WAN) acceleration.

    - SMB 2.1 (2010). SMB 2.1 was introduced with Windows Server 2008 R2 and Windows 7. The client OpLock leasing model replaced OpLock to enhance caching and improve performance. Other updates included large maximum transmission unit support and improved energy efficiency, which enabled clients with open files from an SMB server to enter sleep mode.

    - SMB 3.0 (2012). SMB 3.0 debuted in Windows 8 and Windows Server 2012. It added several significant upgrades to improve availability, performance, backup, security and management. Noteworthy new features included SMB Multichannel, SMB Direct, transparent failover of client access, Remote Volume Shadow Copy Service support, SMB Encryption and more.

    - SMB 3.02 (2014). SMB 3.02 was introduced in Windows 8.1 and Windows Server 2012 R2. It included performance updates and the ability to disable CIFS/SMB 1.0 support, including removal of the related binaries.

    - SMB 3.1.1 (2015). SMB 3.1.1 was released with Windows 10 and Windows Server 2016. It added support for advanced encryption, pre-authentication integrity to prevent man-in-the-middle (MitM) attacks and cluster dialect fencing, among other updates.


## is the SMB protocol safe?

In 2017, the WannaCry and Petya ransomware attacks exploited a vulnerability in SMB 1.0 that made it possible to load malware on vulnerable clients and then propagate the malware across networks. Microsoft subsequently released a patch, but experts have advised users and administrators to disable SMB 1.0/CIFS on all systems.

SMB 3.0 and later are far more secure than previous dialects, having introduced a number of protections. For example, SMB 3.0 added end-to-end data encryption, while protecting data from eavesdropping. SMB 3.0 also offered secure dialect negotiation, which helps protect against MitM attacks.

SMB 3.1.1 improved on security even further by updating the encryption capabilities, adding pre-authentication integrity. It also included a mechanism for negotiating the crypto-algorithm on a per-connection basis.

## What is SMBGhost Vulnerability? 

- SMBGhost (or SMBleedingGhost or CoronaBlue) is a type of security vulnerability, with wormlike features(similar to WannaCry attacks), that affects Windows 10 computers and was first reported publicly on 10 March 2020. 

- An update for this vulnerability was released in March [2020], and Microsoft customers who have installed the updates, or have automatic updates enabled, are already protected." Workarounds, according to Microsoft, such as disabling SMB compression and blocking port 445, may help but may not be sufficient.​

## Affected Devices and Context
According to Microsoft, the vulnerability exists in a new feature released on version 1903 of Windows 10, hence prior versions are unaffected. The affected version are delineated in the table below. 

While it's believed that the cross-industry average of SMBGhost-vulnerable Windows devices with open TCP 445 ports is around 27%, the percentage of such devices found in hospitals​ is around 15%. 

# Demo - CVE-2020-0796 (SMBGhost)

The CVE-2020-0796 (SMBGhost) vulnerability causes an integer overflow in the process of dealing with OriginalSize and Offset inside the Srv2!Srv2DecompressData function which processes compressed messages in the Microsoft SMB 3.1.1 (SMBV3) protocol. The vulnerability could result in system failure, privilege escalation, and remote code execution. In this demo, system failure of blue screen is reenacted.

## Demo Scenario
In the scenario, first, an attacker searches a target by scan network, and after finding the target, the attacker checks if the target pc is Windows system and it open SMB port which is 445 port. Then, he checks if the user has SMBv3 which is vulnerability enabled with a script. Next, he sends manipulated SMB compress packet to the target. Finally, the attack occurs Blue Screeen in the user's PC.

![image](https://user-images.githubusercontent.com/94558947/160330035-643c247b-eb10-468e-a5c0-c485a6e337fc.png)

### 1. Search a target and check SMB port

**1.1 Scan hosts**

```
nmap -sP 192.168.163.0/24
```
![image](https://user-images.githubusercontent.com/94558947/160330817-cd520b5e-7cb8-4f9c-95fe-aab55ac674d4.png)

**1.2 Check OS system and ports**

```
nmap -O -sV 192.168.163.135
```
![image](https://user-images.githubusercontent.com/94558947/160330983-c9135bb7-bdea-49ff-8b38-369a85c0a9fb.png)

### 2. Check vulnerability with python script

The attacker checks with python script whether the target has SMBv3 enabled. 

![image](https://user-images.githubusercontent.com/94558947/160342760-43cc9038-3e36-4566-9d86-ff337fce9f99.png)

```
python3 scanner.py 192.168.163.135
```

### 3. Attack vulnerability with python script

The attacker sends the manipulated SMB compress packet to target. At first, the victim's pc is still alive.

![image](https://user-images.githubusercontent.com/94558947/160342523-1ce6ab35-064a-4a86-9682-00294e380100.png)

 ```
python3 crash.py 192.168.163.135
```

### 4. Blue Screen on target PC

Finally, attack occurs blue screen on the victim's PC.

![image](https://user-images.githubusercontent.com/94558947/160342620-d9820b07-041b-4069-ae58-3505f7d7b5a7.png)


# References

1. Wikipedia 
2. https://www.techtarget.com/searchnetworking/definition/Server-Message-Block-Protocol
3. https://blog.cybermdx.com/the-smbghost-vulnerability-what-to-know-what-to-do
